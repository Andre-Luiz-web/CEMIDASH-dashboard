{% extends "dashboard/base.html" %}
{% load dashboard_extras %}

{% block title %}Dashboard visual{% endblock %}
{% block page_heading %}Dashboard visual{% endblock %}
{% block page_subheading %}Insights gráficos, estatísticas avançadas e distribuição das notas{% endblock %}

{% block extra_styles %}
.hero-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 20px;
    margin-bottom: 28px;
}
.hero-card {
    background: var(--card);
    padding: 22px;
    border-radius: 18px;
    box-shadow: 0 28px 50px -48px rgba(15, 23, 42, 0.6);
    display: flex;
    flex-direction: column;
    gap: 8px;
}
.hero-card h3 {
    margin: 0;
    font-size: 13px;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--muted);
}
.hero-card strong {
    font-size: 32px;
    letter-spacing: -0.03em;
}
.filters {
    background: var(--card);
    border-radius: 18px;
    padding: 28px;
    margin-bottom: 28px;
    box-shadow: 0 24px 45px -40px rgba(15, 23, 42, 0.55);
}
.filters form {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 18px;
    align-items: end;
}
.filters label {
    display: flex;
    flex-direction: column;
    font-size: 13px;
    color: var(--muted);
    gap: 6px;
}
.filters input,
.filters select,
.filters button {
    padding: 11px 14px;
    border-radius: 12px;
    border: 1px solid rgba(148, 163, 184, 0.35);
    background: #fff;
    font-size: 14px;
    transition: all 0.2s ease;
}
.filters input:focus,
.filters select:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 3px var(--accent-soft);
}
.filters button {
    background: var(--accent);
    color: #fff;
    border: none;
    font-weight: 600;
    cursor: pointer;
    box-shadow: 0 16px 28px -20px rgba(37, 99, 235, 0.7);
}
.filters button:hover { transform: translateY(-1px); }

.status-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 20px;
    margin-bottom: 32px;
}
.status-card {
    background: var(--card);
    border-radius: 18px;
    padding: 22px;
    display: grid;
    gap: 12px;
    border: 1px solid rgba(148, 163, 184, 0.18);
}
.status-icon {
    width: 40px;
    height: 40px;
    border-radius: 12px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
}
.status-content h3 {
    margin: 0;
    font-size: 15px;
    letter-spacing: -0.01em;
}
.status-progress {
    position: relative;
    width: 100%;
    height: 8px;
    background: rgba(148, 163, 184, 0.2);
    border-radius: 999px;
    overflow: hidden;
}
.status-progress span {
    display: block;
    height: 100%;
    border-radius: inherit;
}

.charts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-bottom: 32px;
}
.chart-card {
    background: var(--card);
    border-radius: 18px;
    padding: 24px;
    box-shadow: 0 28px 55px -46px rgba(15, 23, 42, 0.58);
}
.chart-card h3 {
    margin: 0 0 12px;
    font-size: 16px;
}

.highlights {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    gap: 20px;
    margin-bottom: 32px;
}
.highlight-card {
    background: var(--card);
    border-radius: 18px;
    padding: 18px 22px;
    box-shadow: 0 24px 50px -48px rgba(15, 23, 42, 0.6);
}
.highlight-card ul {
    list-style: none;
    padding: 0;
    margin: 14px 0 0;
    display: grid;
    gap: 12px;
}
.highlight-card li {
    display: flex;
    justify-content: space-between;
    gap: 12px;
}

table {
    width: 100%;
    border-collapse: collapse;
    background: var(--card);
    border-radius: 18px;
    overflow: hidden;
    box-shadow: 0 28px 60px -48px rgba(15, 23, 42, 0.65);
}
thead { background: #f1f5f9; }
th, td {
    padding: 14px 16px;
    font-size: 14px;
    text-align: left;
}
tbody tr:nth-child(odd) { background: #f8fafc; }
tbody tr:hover { background: rgba(37, 99, 235, 0.08); }
.status-pill {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 6px 12px;
    border-radius: 999px;
    background: var(--pill-bg);
    color: var(--pill-color);
    font-weight: 600;
    font-size: 13px;
}
.pill-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: currentColor;
}
.sort-link {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    color: inherit;
    text-decoration: none;
    font-weight: 600;
}
.sort-icon { font-size: 12px; color: var(--muted); }
.sort-link.active .sort-icon { color: var(--accent); }
.pagination {
    margin-top: 18px;
    display: flex;
    justify-content: flex-end;
    gap: 12px;
    align-items: center;
}
.page-link {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 8px 14px;
    border-radius: 999px;
    border: 1px solid rgba(37, 99, 235, 0.35);
    color: var(--brand);
    text-decoration: none;
    font-weight: 600;
}
.page-link.disabled {
    opacity: 0.45;
    pointer-events: none;
    color: var(--muted);
    border-color: rgba(148, 163, 184, 0.4);
}
.page-info { color: var(--muted); font-size: 14px; }
.muted { color: var(--muted); font-size: 13px; }
.empty-state {
    margin-top: 24px;
    padding: 48px;
    text-align: center;
    border-radius: var(--radius);
    border: 1px dashed var(--border);
    color: var(--muted);
    background: linear-gradient(135deg, rgba(148, 163, 184, 0.08), transparent 70%);
}
{% endblock %}

{% block content %}
    <section class="hero-grid">
        <article class="hero-card">
            <h3>Total de estudantes</h3>
            <strong>{{ insights.total }}</strong>
            <span class="muted">De {{ total_estudantes }} registros carregados</span>
        </article>
        <article class="hero-card">
            <h3>Média</h3>
            <strong>{{ insights.media|floatformat:2 }}</strong>
            <span class="muted">Média aritmética das notas filtradas</span>
        </article>
        <article class="hero-card">
            <h3>Mediana</h3>
            <strong>{{ insights.mediana|floatformat:2 }}</strong>
            <span class="muted">Valor central da distribuição</span>
        </article>
        <article class="hero-card">
            <h3>Desvio padrão</h3>
            <strong>{{ insights.desvio_padrao|floatformat:2 }}</strong>
            <span class="muted">Dispersão relativa das notas</span>
        </article>
    </section>

    <section class="filters">
        <form method="get">
            <label>
                Turma
                <select name="turma">
                    <option value="">Todas</option>
                    {% for turma in turmas %}
                        <option value="{{ turma }}" {% if filters.turma == turma %}selected{% endif %}>{{ turma }}</option>
                    {% endfor %}
                </select>
            </label>
            <label>
                Planilha
                <select name="arquivo">
                    <option value="">Todas</option>
                    {% for arquivo in arquivos %}
                        <option value="{{ arquivo }}" {% if filters.arquivo == arquivo %}selected{% endif %}>{{ arquivo }}</option>
                    {% endfor %}
                </select>
            </label>
            <label>
                Nome do estudante
                <input type="text" name="nome" placeholder="Ex.: Ana" value="{{ filters.nome }}">
            </label>
            <label>
                Nota mínima
                <input type="number" step="0.1" name="nota_min" value="{{ filters.nota_min|default_if_none:'' }}">
            </label>
            <label>
                Nota máxima
                <input type="number" step="0.1" name="nota_max" value="{{ filters.nota_max|default_if_none:'' }}">
            </label>
            <button type="submit">Aplicar filtros</button>
        </form>
    </section>

    {% if insights.total %}
        <section class="status-grid">
            {% for status in visual_data.status_summary %}
                <article class="status-card" style="--accent: {{ status.color }}; background: {{ status.bg }}33;">
                    <div class="status-icon" style="color: {{ status.color }}; background: {{ status.bg }};">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            {% if status.icon == "alert-triangle" %}
                                <path d="M12 3.5L20.5 19H3.5L12 3.5z"></path>
                                <path d="M12 10v4" stroke-linecap="round"></path>
                                <path d="M12 16.5h0" stroke-linecap="round"></path>
                            {% elif status.icon == "alert-circle" %}
                                <circle cx="12" cy="12" r="9"></circle>
                                <path d="M12 8v4" stroke-linecap="round"></path>
                                <path d="M12 16h0" stroke-linecap="round"></path>
                            {% elif status.icon == "check-circle" %}
                                <circle cx="12" cy="12" r="9"></circle>
                                <path d="M9.2 12.3l1.9 1.9 4.1-4.1" stroke-linecap="round" stroke-linejoin="round"></path>
                            {% elif status.icon == "sparkles" %}
                                <path d="M12 5.5l1.2 2.8 2.8 1.2-2.8 1.2-1.2 2.8-1.2-2.8-2.8-1.2 2.8-1.2z"></path>
                                <path d="M6 4l0.7 1.6L8.3 6.3 6.7 7 6 8.6 5.3 7 3.7 6.3 5.3 5.6z"></path>
                                <path d="M18 15.5l0.8 1.8 1.8 0.8-1.8 0.8-0.8 1.8-0.8-1.8-1.8-0.8 1.8-0.8z"></path>
                            {% elif status.icon == "shield-check" %}
                                <path d="M12 3l7 3v5c0 4.4-3 8.4-7 9.5-4-1.1-7-5.1-7-9.5V6l7-3z"></path>
                                <path d="M9.5 12.5l1.8 1.8 3.4-3.4" stroke-linecap="round" stroke-linejoin="round"></path>
                            {% endif %}
                        </svg>
                    </div>
                    <div class="status-content">
                        <h3>{{ status.label }}</h3>
                        <span class="muted">{{ status.range }}</span>
                    </div>
                    <div class="status-progress">
                        <span style="background: {{ status.color }}; width: {{ status.percentage }}%;"></span>
                    </div>
                    <div class="muted"><strong>{{ status.count }}</strong> alunos • {{ status.percentage }}%</div>
                </article>
            {% endfor %}
        </section>

        <section class="charts-grid">
            <article class="chart-card">
                <h3>Distribuição por estado de nota</h3>
                <canvas id="statusChart" height="220"></canvas>
            </article>
            <article class="chart-card">
                <h3>Médias por turma</h3>
                <canvas id="turmaChart" height="220"></canvas>
            </article>
            <article class="chart-card">
                <h3>Ranking das notas exibidas</h3>
                <canvas id="sparklineChart" height="220"></canvas>
            </article>
            <article class="chart-card">
                <h3>Dispersão nota x acerto</h3>
                <canvas id="scatterChart" height="220"></canvas>
            </article>
            <article class="chart-card">
                <h3>Curva percentílica</h3>
                <canvas id="curveChart" height="220"></canvas>
            </article>
        </section>

        <section class="hero-grid" style="margin-bottom: 32px;">
            <article class="hero-card">
                <h3>Nota mínima</h3>
                <strong>{{ visual_data.boxplot.min|floatformat:2 }}</strong>
            </article>
            <article class="hero-card">
                <h3>1º quartil</h3>
                <strong>{{ visual_data.boxplot.q1|floatformat:2 }}</strong>
            </article>
            <article class="hero-card">
                <h3>Mediana</h3>
                <strong>{{ visual_data.boxplot.median|floatformat:2 }}</strong>
            </article>
            <article class="hero-card">
                <h3>3º quartil</h3>
                <strong>{{ visual_data.boxplot.q3|floatformat:2 }}</strong>
            </article>
            <article class="hero-card">
                <h3>Nota máxima</h3>
                <strong>{{ visual_data.boxplot.max|floatformat:2 }}</strong>
            </article>
        </section>

        <section class="highlights">
            <article class="highlight-card">
                <h4>Top 5 desempenhos</h4>
                <ul>
                    {% for aluno in visual_data.top_students %}
                        <li>
                            <div>
                                <strong>{{ aluno.nome }}</strong>
                                <div class="muted">{{ aluno.turma }} • {{ aluno.status.label }}</div>
                            </div>
                            <div style="text-align: right;">
                                <strong>{{ aluno.nota|floatformat:2 }}</strong>
                                <div class="muted">{{ aluno.percentual_nota|floatformat:1 }}%</div>
                            </div>
                        </li>
                    {% empty %}
                        <li class="muted">Nenhum aluno disponível.</li>
                    {% endfor %}
                </ul>
            </article>
            <article class="highlight-card">
                <h4>Maiores oportunidades (Top 5)</h4>
                <ul>
                    {% for aluno in visual_data.bottom_students %}
                        <li>
                            <div>
                                <strong>{{ aluno.nome }}</strong>
                                <div class="muted">{{ aluno.turma }} • {{ aluno.status.label }}</div>
                            </div>
                            <div style="text-align: right;">
                                <strong>{{ aluno.nota|floatformat:2 }}</strong>
                                <div class="muted">{{ aluno.percentual_nota|floatformat:1 }}%</div>
                            </div>
                        </li>
                    {% empty %}
                        <li class="muted">Nenhum aluno disponível.</li>
                    {% endfor %}
                </ul>
            </article>
            <article class="highlight-card">
                <h4>Questões de maior atenção</h4>
                <ul>
                    {% for questao in insights.questoes_dificeis %}
                        <li>
                            <div>
                                <strong>Questão {{ questao.questao }}</strong>
                                <div class="muted">Gabarito {{ questao.gabarito }}</div>
                            </div>
                            <div class="muted">{{ questao.taxa_acerto|floatformat:1 }}% de acerto</div>
                        </li>
                    {% empty %}
                        <li class="muted">Sem dados suficientes.</li>
                    {% endfor %}
                </ul>
            </article>
        </section>

        <section class="chart-card" style="margin-bottom: 32px;">
            <h3>Detalhes por estudante</h3>
            <div style="overflow-x: auto;">
                <table>
                    <thead>
                        <tr>
                            {% for header in student_table_headers %}
                                <th>
                                    <a
                                        class="sort-link{% if header.is_active %} active {{ header.direction }}{% endif %}"
                                        href="?{% querystring sort=header.id direction=header.next_direction page=None %}"
                                        title="Ordenar por {{ header.label }}"
                                    >
                                        {{ header.label }}
                                        <span class="sort-icon">
                                            {% if header.is_active %}
                                                {% if header.direction == "asc" %}&uarr;{% else %}&darr;{% endif %}
                                            {% else %}
                                                &#8597;
                                            {% endif %}
                                        </span>
                                    </a>
                                </th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for aluno in students %}
                            <tr>
                                <td>{{ aluno.turma }}</td>
                                <td>{{ aluno.nome }}</td>
                                <td>
                                    <span class="status-pill" style="--pill-bg: {{ aluno.status.bg }}; --pill-color: {{ aluno.status.color }};">
                                        <span class="pill-dot"></span>
                                        {{ aluno.status.label }}
                                    </span>
                                </td>
                                <td>{{ aluno.nota|floatformat:2 }}</td>
                                <td>{{ aluno.percentual_nota|floatformat:1 }}%</td>
                                <td>{{ aluno.acertos }}/{{ aluno.total_questoes }}</td>
                                <td>{{ aluno.percentual_acertos|floatformat:1 }}%</td>
                                <td>{{ aluno.arquivo }}</td>
                            </tr>
                        {% empty %}
                            <tr>
                                <td colspan="8" class="muted">Nenhum estudante encontrado com os filtros aplicados.</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% if is_paginated %}
                    <div class="pagination">
                        {% if page_obj.has_previous %}
                            <a class="page-link" href="?{% querystring page=page_obj.previous_page_number %}">&larr; Anterior</a>
                        {% else %}
                            <span class="page-link disabled">&larr; Anterior</span>
                        {% endif %}
                        <span class="page-info">Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}</span>
                        {% if page_obj.has_next %}
                            <a class="page-link" href="?{% querystring page=page_obj.next_page_number %}">Próxima &rarr;</a>
                        {% else %}
                            <span class="page-link disabled">Próxima &rarr;</span>
                        {% endif %}
                    </div>
                {% endif %}
            </div>
        </section>
    {% else %}
        <div class="empty-state card">
            Nenhum dado disponível para os filtros selecionados. Ajuste os filtros ou limpe a busca para visualizar o dashboard.
        </div>
    {% endif %}
{% endblock %}

{% block extra_scripts %}
    {% if insights.total %}
        {{ visual_data|json_script:"visual-data" }}
        <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.6/dist/chart.umd.min.js"></script>
        <script>
            const visualData = JSON.parse(document.getElementById("visual-data").textContent);

            const buildCharts = () => {
                const statusCanvas = document.getElementById("statusChart");
                if (statusCanvas) {
                    new Chart(statusCanvas, {
                        type: "doughnut",
                        data: {
                            labels: visualData.status_summary.map(item => item.label),
                            datasets: [{
                                data: visualData.status_summary.map(item => item.count),
                                backgroundColor: visualData.status_summary.map(item => item.color),
                                borderWidth: 0,
                            }],
                        },
                        options: {
                            plugins: {
                                legend: {
                                    position: "bottom",
                                },
                            },
                        },
                    });
                }

                const turmaCanvas = document.getElementById("turmaChart");
                if (turmaCanvas) {
                    new Chart(turmaCanvas, {
                        type: "bar",
                        data: {
                            labels: visualData.turma_chart.labels,
                            datasets: [{
                                label: "Média da turma",
                                data: visualData.turma_chart.medias,
                                backgroundColor: visualData.turma_chart.colors,
                            }],
                        },
                        options: {
                            scales: {
                                y: { beginAtZero: true, max: 10 },
                            },
                        },
                    });
                }

                const sparklineCanvas = document.getElementById("sparklineChart");
                if (sparklineCanvas) {
                    new Chart(sparklineCanvas, {
                        type: "line",
                        data: {
                            labels: visualData.sparkline.labels,
                            datasets: [{
                                label: "Notas",
                                data: visualData.sparkline.values,
                                fill: false,
                                tension: 0.3,
                                borderColor: "#2563eb",
                                backgroundColor: "#2563eb",
                            }],
                        },
                        options: {
                            scales: {
                                y: { beginAtZero: true, max: 10 },
                            },
                        },
                    });
                }

                const scatterCanvas = document.getElementById("scatterChart");
                if (scatterCanvas) {
                    new Chart(scatterCanvas, {
                        type: "scatter",
                        data: {
                            datasets: [{
                                label: "Estudantes",
                                data: visualData.scatter.map(item => ({ x: item.x, y: item.y })),
                                backgroundColor: "rgba(37,99,235,0.5)",
                                borderColor: "#2563eb",
                            }],
                        },
                        options: {
                            parsing: false,
                            plugins: {
                                tooltip: {
                                    callbacks: {
                                        label(context) {
                                            const point = visualData.scatter[context.dataIndex];
                                            return `${point.nome} (${point.turma}) — Nota ${point.x}% / Acertos ${point.y}%`;
                                        },
                                    },
                                },
                            },
                            scales: {
                                x: { min: 0, max: 100, title: { display: true, text: "% da nota" } },
                                y: { min: 0, max: 100, title: { display: true, text: "% de acertos" } },
                            },
                        },
                    });
                }

                const curveCanvas = document.getElementById("curveChart");
                if (curveCanvas) {
                    new Chart(curveCanvas, {
                        type: "line",
                        data: {
                            labels: visualData.percentile_curve.labels,
                            datasets: [{
                                label: "Percentil",
                                data: visualData.percentile_curve.values,
                                borderColor: "#7c3aed",
                                backgroundColor: "rgba(124,58,237,0.2)",
                                fill: true,
                                tension: 0.3,
                            }],
                        },
                        options: {
                            scales: {
                                x: { title: { display: true, text: "Percentil (%)" } },
                                y: { beginAtZero: true, max: 10, title: { display: true, text: "Nota" } },
                            },
                        },
                    });
                }
            };

            document.addEventListener("DOMContentLoaded", buildCharts);
        </script>
    {% endif %}
{% endblock %}
