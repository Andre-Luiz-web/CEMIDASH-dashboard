{% extends "dashboard/base.html" %}
{% load dashboard_extras %}

{% block title %}Visão consolidada{% endblock %}
{% block page_heading %}Visão consolidada{% endblock %}
{% block page_subheading %}Panorama analítico das notas, turmas e estudantes{% endblock %}

{% block extra_styles %}
.hero-banner {
    margin-bottom: 28px;
    padding: 28px;
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.75), rgba(14, 165, 233, 0.65));
    color: #f8fafc;
    border-radius: 22px;
    box-shadow: 0 32px 60px -44px rgba(37, 99, 235, 0.7);
}
.hero-banner h1 {
    margin: 0 0 6px;
    font-size: 32px;
    letter-spacing: -0.02em;
}
.hero-banner p {
    margin: 0;
    font-size: 15px;
    color: rgba(248, 250, 252, 0.9);
}
.filters {
    background: var(--card);
    border-radius: 18px;
    padding: 28px;
    margin-bottom: 28px;
    box-shadow: 0 24px 45px -40px rgba(15, 23, 42, 0.55);
}
.filters form {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 18px;
    align-items: end;
}
.filters label {
    display: flex;
    flex-direction: column;
    font-size: 13px;
    color: var(--muted);
    gap: 6px;
}
.filters input,
.filters select,
.filters button {
    padding: 11px 14px;
    border-radius: 12px;
    border: 1px solid rgba(148, 163, 184, 0.35);
    background: #fff;
    font-size: 14px;
    transition: all 0.2s ease;
}
.filters input:focus,
.filters select:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 3px var(--accent-soft);
}
.filters button {
    background: var(--accent);
    color: #fff;
    border: none;
    font-weight: 600;
    cursor: pointer;
    box-shadow: 0 16px 28px -20px rgba(37, 99, 235, 0.7);
}
.filters button:hover { transform: translateY(-1px); }

.card-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 20px;
    margin-bottom: 32px;
}
.card {
    background: var(--card);
    padding: 22px;
    border-radius: 18px;
    box-shadow: 0 28px 50px -46px rgba(15, 23, 42, 0.65);
    display: flex;
    flex-direction: column;
    gap: 8px;
}
.card h3 {
    margin: 0;
    font-size: 13px;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--muted);
}
.card strong {
    font-size: 28px;
    letter-spacing: -0.02em;
}

.two-column {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    gap: 20px;
    margin-bottom: 32px;
}
.list-card ul {
    list-style: none;
    padding: 0;
    margin: 0;
    display: grid;
    gap: 10px;
}
.list-card li {
    padding: 12px 14px;
    border-radius: 12px;
    background: rgba(148, 163, 184, 0.15);
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 14px;
}

table {
    width: 100%;
    border-collapse: collapse;
    background: var(--card);
    border-radius: 18px;
    overflow: hidden;
    box-shadow: 0 28px 60px -48px rgba(15, 23, 42, 0.65);
}
thead { background: #f1f5f9; }
th, td {
    padding: 14px 16px;
    font-size: 14px;
    text-align: left;
}
tbody tr:nth-child(odd) { background: #f8fafc; }
tbody tr:hover { background: rgba(37, 99, 235, 0.08); }
.sort-link {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    color: inherit;
    text-decoration: none;
    font-weight: 600;
}
.sort-icon {
    font-size: 12px;
    color: var(--muted);
}
.sort-link.active .sort-icon { color: var(--accent); }

.pagination {
    margin-top: 18px;
    display: flex;
    justify-content: flex-end;
    gap: 12px;
    align-items: center;
}
.page-link {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 8px 14px;
    border-radius: 999px;
    border: 1px solid rgba(37, 99, 235, 0.35);
    color: var(--accent);
    text-decoration: none;
    font-weight: 600;
}
.page-link.disabled {
    opacity: 0.45;
    pointer-events: none;
    color: var(--muted);
    border-color: rgba(148, 163, 184, 0.4);
}
.page-info { color: var(--muted); font-size: 14px; }
.muted { color: var(--muted); font-size: 13px; }
.empty-state {
    padding: 48px;
    background: var(--card);
    border-radius: 18px;
    text-align: center;
    box-shadow: 0 28px 60px -50px rgba(15, 23, 42, 0.55);
    font-size: 16px;
}
{% endblock %}

{% block content %}
    <section class="hero-banner">
        <h1>Desempenho geral das avaliações</h1>
        <p>Explore indicadores, tendências e destaques para orientar intervenções pedagógicas.</p>
    </section>

    <section class="filters">
        <form method="get">
            <label>
                Turma
                <select name="turma">
                    <option value="">Todas</option>
                    {% for turma in turmas %}
                        <option value="{{ turma }}" {% if filters.turma == turma %}selected{% endif %}>{{ turma }}</option>
                    {% endfor %}
                </select>
            </label>
            <label>
                Planilha
                <select name="arquivo">
                    <option value="">Todas</option>
                    {% for arquivo in arquivos %}
                        <option value="{{ arquivo }}" {% if filters.arquivo == arquivo %}selected{% endif %}>{{ arquivo }}</option>
                    {% endfor %}
                </select>
            </label>
            <label>
                Nome do estudante
                <input type="text" name="nome" placeholder="Ex.: Ana" value="{{ filters.nome }}">
            </label>
            <label>
                Nota mínima
                <input type="number" step="0.1" name="nota_min" value="{{ filters.nota_min|default_if_none:'' }}">
            </label>
            <label>
                Nota máxima
                <input type="number" step="0.1" name="nota_max" value="{{ filters.nota_max|default_if_none:'' }}">
            </label>
            <button type="submit">Aplicar</button>
        </form>
    </section>

    <section class="card-grid">
        <div class="card">
            <h3>Total filtrado</h3>
            <strong>{{ insights.total }}</strong>
            <p class="muted">De {{ total_estudantes }} estudantes carregados</p>
        </div>
        <div class="card">
            <h3>Média geral</h3>
            <strong>{{ insights.media|floatformat:2 }}</strong>
            <p class="muted">Nota média do conjunto filtrado</p>
        </div>
        <div class="card">
            <h3>Melhor aluno</h3>
            {% if insights.melhor %}
                <strong>{{ insights.melhor.nome }}</strong>
                <p class="muted">Nota {{ insights.melhor.nota|floatformat:2 }} — {{ insights.melhor.turma }}</p>
            {% else %}
                <strong>—</strong>
                <p class="muted">Sem dados disponíveis</p>
            {% endif %}
        </div>
        <div class="card">
            <h3>Pior aluno</h3>
            {% if insights.pior %}
                <strong>{{ insights.pior.nome }}</strong>
                <p class="muted">Nota {{ insights.pior.nota|floatformat:2 }} — {{ insights.pior.turma }}</p>
            {% else %}
                <strong>—</strong>
                <p class="muted">Sem dados disponíveis</p>
            {% endif %}
        </div>
    </section>

    {% if insights.total %}
        <section class="two-column">
            <div class="card list-card">
                <h3>Top 5 desempenhos</h3>
                <ul>
                    {% for aluno in insights.top %}
                        <li>
                            <span>{{ aluno.nome }} <span class="muted">({{ aluno.turma }})</span></span>
                            <strong>{{ aluno.nota|floatformat:2 }}</strong>
                        </li>
                    {% empty %}
                        <li class="muted">Nenhum aluno encontrado.</li>
                    {% endfor %}
                </ul>
            </div>
            <div class="card list-card">
                <h3>Maiores dificuldades</h3>
                <ul>
                    {% for aluno in insights.bottom %}
                        <li>
                            <span>{{ aluno.nome }} <span class="muted">({{ aluno.turma }})</span></span>
                            <strong>{{ aluno.nota|floatformat:2 }}</strong>
                        </li>
                    {% empty %}
                        <li class="muted">Nenhum aluno encontrado.</li>
                    {% endfor %}
                </ul>
            </div>
        </section>

        <section class="two-column">
            <div class="card list-card">
                <h3>Questões mais desafiadoras</h3>
                <ul>
                    {% for questao in insights.questoes_dificeis %}
                        <li>
                            <span>Questão {{ questao.questao }} <span class="muted">Gabarito {{ questao.gabarito }}</span></span>
                            <strong>{{ questao.taxa_acerto|floatformat:1 }}%</strong>
                        </li>
                    {% empty %}
                        <li class="muted">Sem dados suficientes.</li>
                    {% endfor %}
                </ul>
            </div>
            <div class="card list-card">
                <h3>Questões com maior acerto</h3>
                <ul>
                    {% for questao in insights.questoes_faceis %}
                        <li>
                            <span>Questão {{ questao.questao }} <span class="muted">Gabarito {{ questao.gabarito }}</span></span>
                            <strong>{{ questao.taxa_acerto|floatformat:1 }}%</strong>
                        </li>
                    {% empty %}
                        <li class="muted">Sem dados suficientes.</li>
                    {% endfor %}
                </ul>
            </div>
        </section>

        <section class="card">
            <h3>Resumo por turma</h3>
            <table>
                <thead>
                    <tr>
                        <th>Turma</th>
                        <th>Qtd. alunos</th>
                        <th>Média</th>
                        <th>Melhor nota</th>
                        <th>Pior nota</th>
                    </tr>
                </thead>
                <tbody>
                    {% for turma in insights.turmas %}
                        <tr>
                            <td>{{ turma.nome }}</td>
                            <td>{{ turma.total }}</td>
                            <td>{{ turma.media|floatformat:2 }}</td>
                            <td>{{ turma.melhor.nota|floatformat:2 }} — {{ turma.melhor.nome }}</td>
                            <td>{{ turma.pior.nota|floatformat:2 }} — {{ turma.pior.nome }}</td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="5" class="muted">Nenhuma turma encontrada.</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </section>

        <section style="margin-top: 28px;">
            <h3 class="muted">Detalhe por estudante</h3>
            <table>
                <thead>
                    <tr>
                        {% for header in student_table_headers %}
                            <th>
                                <a
                                    class="sort-link{% if header.is_active %} active {{ header.direction }}{% endif %}"
                                    href="?{% querystring sort=header.id direction=header.next_direction page=None %}"
                                    title="Ordenar por {{ header.label }}"
                                >
                                    {{ header.label }}
                                    <span class="sort-icon">
                                        {% if header.is_active %}
                                            {% if header.direction == "asc" %}&uarr;{% else %}&darr;{% endif %}
                                        {% else %}
                                            &#8597;
                                        {% endif %}
                                    </span>
                                </a>
                            </th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for aluno in students %}
                        <tr>
                            <td>{{ aluno.turma }}</td>
                            <td>{{ aluno.nome }}</td>
                            <td>{{ aluno.nota|floatformat:2 }}</td>
                            <td>{{ aluno.percentual_nota|floatformat:1 }}%</td>
                            <td>{{ aluno.acertos }}/{{ aluno.total_questoes }}</td>
                            <td>{{ aluno.percentual_acertos|floatformat:1 }}%</td>
                            <td>{{ aluno.arquivo }}</td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="7" class="muted">Nenhum estudante encontrado com os filtros aplicados.</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% if is_paginated %}
                <div class="pagination">
                    {% if page_obj.has_previous %}
                        <a class="page-link" href="?{% querystring page=page_obj.previous_page_number %}">&larr; Anterior</a>
                    {% else %}
                        <span class="page-link disabled">&larr; Anterior</span>
                    {% endif %}
                    <span class="page-info">Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}</span>
                    {% if page_obj.has_next %}
                        <a class="page-link" href="?{% querystring page=page_obj.next_page_number %}">Próxima &rarr;</a>
                    {% else %}
                        <span class="page-link disabled">Próxima &rarr;</span>
                    {% endif %}
                </div>
            {% endif %}
        </section>
    {% else %}
        <div class="empty-state">
            Nenhum dado disponível para os filtros selecionados. Ajuste os filtros para visualizar o dashboard.
        </div>
    {% endif %}
{% endblock %}
